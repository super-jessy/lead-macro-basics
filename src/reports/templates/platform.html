<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>DELTA TERMINAL - MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:16px; }
    .tabs { display:flex; gap:8px; margin:8px 0 12px; flex-wrap:wrap; }
    .tab { padding:6px 10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; user-select:none; }
    .tab.active { background:#1f77b4; color:#fff; border-color:#1f77b4; }
    .panel { display:none; }
    .panel.active { display:block; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:8px 0 12px; }
    .muted { font-size:12px; opacity:.7; }
    #fig_timeseries, #fig_heatmap, #fig_ic { height: 74vh; }
    #errorBox { color:#b00020; white-space: pre-wrap; background:#ffecec; border:1px solid #ffb3b3; padding:8px 10px; border-radius:8px; display:none; }
    .plotly .gl-container .gl-error-message { display: none !important; }
    select, input[type="checkbox"] { cursor: pointer; }
  </style>
</head>
<body>

  <h2 style="margin:4px 0 12px 0;">DELTA TERMINAL - MVP</h2>
  <div id="errorBox"></div>

  <div class="tabs">
    <div class="tab active" data-target="panel-timeseries">Timeseries</div>
    <div class="tab" data-target="panel-heatmap">Heatmap</div>
    <div class="tab" data-target="panel-ic">IC</div>
    <div class="tab" data-target="panel-models">Models (soon)</div>
  </div>

  <div id="panel-timeseries" class="panel active">
    <div class="controls">
      <label>Индикатор:
        <select id="macroSelect" style="margin-left:6px; padding:2px 6px;"></select>
      </label>

      <label>Нормировка:
        <input type="checkbox" id="normChk" style="transform: translateY(2px); margin:0 6px;"> z-score
      </label>

      <label>Лаг (мес): <span id="lagVal">0</span>
        <input type="range" id="lagRange" min="-12" max="12" step="1" value="0" style="vertical-align: middle; margin-left:8px;">
      </label>

      <span class="muted">Положительный лаг сдвигает макро вправо (позже).</span>

      <span style="margin-left:18px;"></span>

      <label>SPX Chart:
        <select id="spxChartType" style="margin-left:6px;">
          <option value="line" selected>Line (log)</option>
          <option value="candles">Candles (OHLC)</option>
        </select>
      </label>

      <label id="spxNormWrap" title="Нормирует лог-цену S&P (только для Line)">
        <input type="checkbox" id="spxNormChk" style="transform: translateY(2px); margin:0 6px;"> Normalize SPX (z-score)
      </label>
    </div>

    <div id="fig_timeseries"></div>
  </div>

  <div id="panel-heatmap" class="panel">
    <div id="fig_heatmap"></div>
  </div>

  <div id="panel-ic" class="panel">
    <div class="controls">
      <label for="icSelect">Индикатор:</label>
      <select id="icSelect"></select>
      <span class="muted">Выбирая индикатор здесь, вы меняете график IC. Для смены индикатора в Timeseries — используйте селектор выше на вкладке Timeseries.</span>
    </div>
    <div id="fig_ic"></div>
  </div>

  <div id="panel-models" class="panel">
    <p class="muted">Здесь появится переключатель моделей и метрики (Sharpe, hit-rate и т.д.).</p>
  </div>

<script>
  function showError(e) {
    const box = document.getElementById('errorBox');
    box.style.display = 'block';
    box.textContent = (e && e.stack) ? e.stack : String(e);
    console.error(e);
  }

  try {
    // ------- ДАННЫЕ из Python (имена ДОЛЖНЫ совпадать с substitute) -------
    const spxCode      = "${spx_code}";
    const spxPayload   = ${spx_payload_json};
    const macroData    = ${macro_payload_json};
    const defaultCode  = "${default_code}";
    const hmFigureSpec = ${hm_fig_json};
    const icPayload    = ${ic_payload_json};
    const icFigureSpec = ${ic_fig_json};

    // ------- вкладки -------
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.target).classList.add('active');
        if (t.dataset.target === 'panel-heatmap' && !window.__hmRendered) {
          Plotly.newPlot('fig_heatmap', hmFigureSpec.data, hmFigureSpec.layout, {responsive:true});
          window.__hmRendered = true;
        }
        if (t.dataset.target === 'panel-ic' && !window.__icRendered) {
          Plotly.newPlot('fig_ic', icFigureSpec.data, icFigureSpec.layout, {responsive:true});
          window.__icRendered = true;
          updateIC(icSelect.value);
        }
      });
    });

    // ------- селекторы -------
    const sel        = document.getElementById('macroSelect');
    const icSelect   = document.getElementById('icSelect');
    const normChk    = document.getElementById('normChk');
    const lagRange   = document.getElementById('lagRange');
    const lagVal     = document.getElementById('lagVal');
    const spxTypeSel = document.getElementById('spxChartType');
    const spxNormChk = document.getElementById('spxNormChk');
    const spxNormWrap= document.getElementById('spxNormWrap');

    Object.keys(macroData).sort().forEach(code => {
      const o1 = document.createElement('option'); o1.value = code; o1.textContent = code;
      if (code === defaultCode) o1.selected = true;
      sel.appendChild(o1);
      const o2 = document.createElement('option'); o2.value = code; o2.textContent = code;
      icSelect.appendChild(o2);
    });
    icSelect.value = defaultCode;

    // ------- функции -------
    function addMonthsISO(iso, m) {
      const d = new Date(iso);
      let year = d.getUTCFullYear();
      let month = d.getUTCMonth();
      const day = d.getUTCDate();
      month += m; year += Math.floor(month/12); month = ((month%12)+12)%12;
      const nd = new Date(Date.UTC(year, month, 1));
      const daysInMonth = new Date(Date.UTC(year, month+1, 0)).getUTCDate();
      nd.setUTCDate(Math.min(day, daysInMonth));
      return nd.toISOString();
    }
    function applyLag(tsArr, m){ if(!m) return tsArr; return tsArr.map(t => addMonthsISO(t, m)); }
    function macroLegendName(code, useZ, lag) {
      const suffix = [];
      if (useZ) suffix.push('z');
      if (lag)  suffix.push(`lag ${lag>0? '+'+lag: lag}m`);
      return suffix.length ? `${code} (${suffix.join(', ')})` : code;
    }

    function baseLayout() {
      return {
        title: {text: `${spxCode} (лог) + макро`, x: 0, xanchor:'left'},
        legend: {orientation:'h', yanchor:'bottom', y:1.02, xanchor:'left', x:0},
        margin: {l:60, r:60, t:70, b:40},
        xaxis: {title:'Дата'},
        yaxis: {title:`log(${spxCode})`},
        yaxis2: {title:'macro', overlaying:'y', side:'right'},
        template:'plotly_white',
        hovermode:'x unified'
      };
    }

    function tracesFromState() {
      const macroCode = sel.value;
      const useZ = normChk.checked;
      const lag = parseInt(lagRange.value, 10) || 0;
      const spxType = spxTypeSel.value;
      const spxUseZ = spxNormChk.checked;

      // SPX
      let spxTrace;
      if (spxType === 'candles') {
        spxTrace = {
          type: 'candlestick',
          x: spxPayload.ts,
          open:  spxPayload.ohlc.open,
          high:  spxPayload.ohlc.high,
          low:   spxPayload.ohlc.low,
          close: spxPayload.ohlc.close,
          name: `${spxCode} (candles)`,
          yaxis: 'y',
          increasing: {line: {width:1.2}},
          decreasing: {line: {width:1.2}},
        };
      } else {
        const y = spxUseZ ? spxPayload.log_z : spxPayload.log;
        spxTrace = {
          type: 'scatter', mode:'lines',
          x: spxPayload.ts, y: y,
          name: spxUseZ ? `${spxCode} (log, z)` : `${spxCode} (log)`,
          line: {width: 2.2},
          yaxis:'y'
        };
      }

      // Macro
      const rec = macroData[macroCode];
      const yMacro = useZ ? rec.z : rec.raw;
      const xMacro = applyLag(rec.ts, lag);
      const macroTrace = {
        type:'scatter', mode:'lines',
        x: xMacro, y: yMacro,
        name: macroLegendName(macroCode, useZ, lag),
        line: {width: 1.5},
        yaxis:'y2'
      };

      return [spxTrace, macroTrace];
    }

    function renderTimeseries() {
      const traces = tracesFromState();
      const spxType = spxTypeSel.value;

      if (spxType === 'candles') {
        spxNormChk.checked = false;
        spxNormWrap.style.opacity = .4;
        spxNormChk.disabled = true;
      } else {
        spxNormWrap.style.opacity = 1;
        spxNormChk.disabled = false;
      }

      const layout = baseLayout();
      layout['yaxis'].title = (spxType === 'candles')
        ? `${spxCode} (OHLC)`
        : (spxNormChk.checked ? `${spxCode} (log, z)` : `log(${spxCode})`);
      layout['yaxis2'].title = sel.value;

      Plotly.react('fig_timeseries', traces, layout, {responsive:true});
      document.getElementById('lagVal').textContent = String(parseInt(lagRange.value, 10) || 0);
    }

    // старт
    renderTimeseries();

    // обработчики
    document.getElementById('macroSelect').addEventListener('change', renderTimeseries);
    document.getElementById('normChk').addEventListener('change', renderTimeseries);
    document.getElementById('lagRange').addEventListener('input', renderTimeseries);
    document.getElementById('spxChartType').addEventListener('change', renderTimeseries);
    document.getElementById('spxNormChk').addEventListener('change', renderTimeseries);

    // IC
    function updateIC(code){
      const item = icPayload[code];
      if (!item) return;
      if (!window.__icRendered) return;
      Plotly.react('fig_ic', [{ x: item.lags, y: item.ic, mode: 'lines+markers', name: 'IC' }], {
        ...icFigureSpec.layout,
        title: {text: 'Information Coefficient (next-month return) — ' + code}
      }, {responsive:true});
    }
    document.getElementById("icSelect").addEventListener("change", (e) => updateIC(e.target.value));

  } catch (e) { showError(e); }
</script>

</body>
</html>
